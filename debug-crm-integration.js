// Debug-Script f√ºr CRM-Integration
// F√ºhren Sie dieses Script aus, um die CRM-Integration zu testen

// Lade .env.local Datei manuell (ohne dotenv)
const fs = require('fs');
const path = require('path');

function loadEnvFile() {
  try {
    const envPath = path.join(__dirname, '.env.local');
    const envContent = fs.readFileSync(envPath, 'utf8');
    
    envContent.split('\n').forEach(line => {
      const trimmedLine = line.trim();
      if (trimmedLine && !trimmedLine.startsWith('#')) {
        const [key, ...valueParts] = trimmedLine.split('=');
        if (key && valueParts.length > 0) {
          const value = valueParts.join('=').replace(/^["']|["']$/g, ''); // Entferne Anf√ºhrungszeichen
          process.env[key.trim()] = value.trim();
        }
      }
    });
    console.log('‚úÖ .env.local erfolgreich geladen');
  } catch (error) {
    console.error('‚ùå Fehler beim Laden der .env.local:', error.message);
    console.error('Stellen Sie sicher, dass die .env.local Datei existiert und die Supabase-Variablen enth√§lt.');
  }
}

// Lade Umgebungsvariablen
loadEnvFile();

const { createClient } = require('@supabase/supabase-js');

// Konfiguration
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('‚ùå Umgebungsvariablen fehlen:');
  console.error('NEXT_PUBLIC_SUPABASE_URL:', supabaseUrl ? '‚úÖ Gesetzt' : '‚ùå Fehlt');
  console.error('SUPABASE_SERVICE_ROLE_KEY:', supabaseServiceKey ? '‚úÖ Gesetzt' : '‚ùå Fehlt');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseServiceKey);

async function debugCRMIntegration() {
  console.log('üîç Debug CRM-Integration\n');

  // 1. Teste Supabase-Verbindung
  console.log('1. Teste Supabase-Verbindung...');
  try {
    const { data, error } = await supabase.from('customers').select('count').limit(1);
    if (error) {
      console.error('‚ùå Supabase-Verbindung fehlgeschlagen:', error.message);
      return;
    }
    console.log('‚úÖ Supabase-Verbindung erfolgreich\n');
  } catch (error) {
    console.error('‚ùå Supabase-Verbindung fehlgeschlagen:', error.message);
    return;
  }

  // 2. Pr√ºfe Tabellen-Schema
  console.log('2. Pr√ºfe customers Tabelle...');
  try {
    const { data, error } = await supabase
      .from('customers')
      .select('*')
      .limit(1);
    
    if (error) {
      console.error('‚ùå Fehler beim Zugriff auf customers Tabelle:', error.message);
      console.error('Details:', error);
      
      // Pr√ºfe ob die Tabelle √ºberhaupt existiert
      if (error.message.includes('does not exist')) {
        console.error('üîç Die customers Tabelle existiert nicht!');
        console.error('Sie m√ºssen das CRM-Schema zuerst in Supabase ausf√ºhren:');
        console.error('1. √ñffnen Sie Supabase Dashboard');
        console.error('2. Gehen Sie zu SQL Editor');
        console.error('3. F√ºhren Sie supabase-crm-extended-schema.sql aus');
        return;
      }
    } else {
      console.log('‚úÖ customers Tabelle ist zug√§nglich');
      const columns = data.length > 0 ? Object.keys(data[0]) : [];
      console.log('Verf√ºgbare Spalten:', columns);
      
      // Pr√ºfe ob CRM-Spalten vorhanden sind
      const requiredCrmColumns = ['lead_status', 'country', 'product_interests', 'priority', 'tags'];
      const missingColumns = requiredCrmColumns.filter(col => !columns.includes(col));
      
      if (missingColumns.length > 0) {
        console.error('‚ùå CRM-Schema ist nicht vollst√§ndig installiert!');
        console.error('Fehlende Spalten:', missingColumns);
        console.error('');
        console.error('L√ñSUNG:');
        console.error('1. √ñffnen Sie Supabase Dashboard ‚Üí SQL Editor');
        console.error('2. F√ºhren Sie supabase-crm-extended-schema.sql aus');
        console.error('3. Oder f√ºhren Sie dieses SQL aus:');
        console.error('');
        console.error('-- F√ºge CRM-Spalten zur bestehenden customers Tabelle hinzu');
        console.error('ALTER TABLE customers ADD COLUMN IF NOT EXISTS lead_status TEXT DEFAULT \'neu\';');
        console.error('ALTER TABLE customers ADD COLUMN IF NOT EXISTS country TEXT DEFAULT \'Deutschland\';');
        console.error('ALTER TABLE customers ADD COLUMN IF NOT EXISTS product_interests TEXT[] DEFAULT \'{}\';');
        console.error('ALTER TABLE customers ADD COLUMN IF NOT EXISTS priority INTEGER DEFAULT 3;');
        console.error('ALTER TABLE customers ADD COLUMN IF NOT EXISTS tags TEXT[] DEFAULT \'{}\';');
        console.error('ALTER TABLE customers ADD COLUMN IF NOT EXISTS lead_source TEXT;');
        console.error('ALTER TABLE customers ADD COLUMN IF NOT EXISTS estimated_value DECIMAL(12,2);');
        console.error('ALTER TABLE customers ADD COLUMN IF NOT EXISTS probability INTEGER;');
        console.error('ALTER TABLE customers ADD COLUMN IF NOT EXISTS notes TEXT;');
        console.error('ALTER TABLE customers ADD COLUMN IF NOT EXISTS gdpr_consent BOOLEAN DEFAULT false;');
        console.error('ALTER TABLE customers ADD COLUMN IF NOT EXISTS marketing_consent BOOLEAN DEFAULT false;');
        return;
      } else {
        console.log('‚úÖ CRM-Schema ist vollst√§ndig installiert');
      }
    }
  } catch (error) {
    console.error('‚ùå Fehler beim Zugriff auf customers Tabelle:', error.message);
  }

  // 3. Teste CRM-Lead Erstellung (nur mit Basis-Spalten)
  console.log('\n3. Teste CRM-Lead Erstellung...');
  const testLeadData = {
    first_name: 'Test',
    last_name: 'Kunde',
    email: `test-${Date.now()}@example.com`
  };
  
  // F√ºge CRM-Spalten nur hinzu, wenn sie existieren
  const { data: schemaCheck } = await supabase.from('customers').select('*').limit(0);
  if (schemaCheck !== null) {
    // Erweiterte CRM-Daten nur wenn Schema vollst√§ndig ist
    testLeadData.country = 'Deutschland';
    testLeadData.lead_status = 'neu';
    testLeadData.lead_source = 'Debug-Test';
    testLeadData.estimated_value = null;
    testLeadData.probability = 25;
    testLeadData.product_interests = ['pv'];
    testLeadData.priority = 3;
    testLeadData.tags = ['debug', 'test'];
    testLeadData.notes = 'Debug-Test Lead';
    testLeadData.gdpr_consent = true;
    testLeadData.marketing_consent = false;
  }

  try {
    const { data: crmLead, error: crmError } = await supabase
      .from('customers')
      .insert([testLeadData])
      .select()
      .single();

    if (crmError) {
      console.error('‚ùå Fehler beim Erstellen des Test-Leads:', crmError.message);
      console.error('Details:', crmError);
      
      // Spezifische Fehleranalyse
      if (crmError.message.includes('enum')) {
        console.error('üîç Enum-Fehler erkannt. M√∂gliche Ursachen:');
        console.error('- product_interests Array enth√§lt ung√ºltige Werte');
        console.error('- lead_status ist ung√ºltig');
        console.error('G√ºltige product_interest Werte: pv, speicher, waermepumpe, fenster, tueren, daemmung, rollaeden');
        console.error('G√ºltige lead_status Werte: neu, qualifiziert, angebot_erstellt, in_verhandlung, gewonnen, verloren');
      }
      
      if (crmError.message.includes('RLS') || crmError.message.includes('policy')) {
        console.error('üîç RLS-Policy-Fehler erkannt. M√∂gliche Ursachen:');
        console.error('- Row Level Security blockiert den Insert');
        console.error('- Service Role Key hat nicht die richtigen Berechtigungen');
      }
    } else {
      console.log('‚úÖ Test-Lead erfolgreich erstellt:', crmLead.id);
      
      // 4. Teste Kontakt-Historie
      console.log('\n4. Teste Kontakt-Historie...');
      try {
        const { data: contactHistory, error: historyError } = await supabase
          .from('contact_history')
          .insert([{
            customer_id: crmLead.id,
            contact_type: 'website_formular',
            subject: 'Debug-Test Kontakt',
            content: 'Test-Nachricht f√ºr Debug',
            direction: 'inbound',
            metadata: {
              debug: true,
              timestamp: new Date().toISOString()
            }
          }])
          .select()
          .single();

        if (historyError) {
          console.error('‚ùå Fehler beim Erstellen der Kontakt-Historie:', historyError.message);
        } else {
          console.log('‚úÖ Kontakt-Historie erfolgreich erstellt:', contactHistory.id);
        }
      } catch (error) {
        console.error('‚ùå Fehler bei Kontakt-Historie:', error.message);
      }

      // 5. Cleanup - Test-Lead l√∂schen
      console.log('\n5. Cleanup - Test-Lead l√∂schen...');
      try {
        const { error: deleteError } = await supabase
          .from('customers')
          .delete()
          .eq('id', crmLead.id);

        if (deleteError) {
          console.error('‚ùå Fehler beim L√∂schen des Test-Leads:', deleteError.message);
        } else {
          console.log('‚úÖ Test-Lead erfolgreich gel√∂scht');
        }
      } catch (error) {
        console.error('‚ùå Fehler beim L√∂schen:', error.message);
      }
    }
  } catch (error) {
    console.error('‚ùå Unerwarteter Fehler:', error.message);
  }

  // 6. Pr√ºfe bestehende Kunden
  console.log('\n6. Pr√ºfe bestehende Kunden...');
  try {
    // Verwende nur Basis-Spalten die sicher existieren
    const { data: existingCustomers, error: listError } = await supabase
      .from('customers')
      .select('id, first_name, last_name, email, created_at')
      .order('created_at', { ascending: false })
      .limit(5);

    if (listError) {
      console.error('‚ùå Fehler beim Laden der Kunden:', listError.message);
    } else {
      console.log('‚úÖ Bestehende Kunden:', existingCustomers.length);
      existingCustomers.forEach(customer => {
        console.log(`- ${customer.first_name} ${customer.last_name} (${customer.email})`);
      });
    }
  } catch (error) {
    console.error('‚ùå Fehler beim Laden der Kunden:', error.message);
  }

  console.log('\nüèÅ Debug abgeschlossen');
}

// Script ausf√ºhren
debugCRMIntegration().catch(console.error);
